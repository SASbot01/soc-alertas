package com.blackwolf.backend.controller;

import com.blackwolf.backend.dto.VulnerabilityDTOs.*;
import com.blackwolf.backend.model.Vulnerability;
import com.blackwolf.backend.service.VulnerabilityService;
import com.blackwolf.backend.util.AuthUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/vulnerabilities")
public class VulnerabilityController {

    @Autowired
    private VulnerabilityService vulnerabilityService;

    @Autowired
    private AuthUtils authUtils;

    @GetMapping
    public ResponseEntity<List<Vulnerability>> list(Authentication auth) {
        return ResponseEntity.ok(vulnerabilityService.listByCompany(authUtils.getCompanyId(auth)));
    }

    @GetMapping("/{id}")
    public ResponseEntity<VulnerabilityDetailResponse> getDetail(Authentication auth, @PathVariable String id) {
        return ResponseEntity.ok(vulnerabilityService.getDetail(id, authUtils.getCompanyId(auth)));
    }

    @PostMapping
    public ResponseEntity<Vulnerability> create(Authentication auth, @RequestBody CreateVulnerabilityRequest request) {
        String companyId = authUtils.getCompanyId(auth);
        String performedBy = authUtils.getUser(auth).getEmail();
        return ResponseEntity.ok(vulnerabilityService.create(companyId, request, performedBy));
    }

    @PatchMapping("/{id}/status")
    public ResponseEntity<Vulnerability> updateStatus(Authentication auth, @PathVariable String id,
                                                       @RequestBody UpdateVulnerabilityStatusRequest request) {
        String companyId = authUtils.getCompanyId(auth);
        String performedBy = authUtils.getUser(auth).getEmail();
        return ResponseEntity.ok(vulnerabilityService.updateStatus(id, companyId, request, performedBy));
    }

    @GetMapping("/dashboard")
    public ResponseEntity<VulnerabilityDashboard> getDashboard(Authentication auth) {
        return ResponseEntity.ok(vulnerabilityService.getDashboard(authUtils.getCompanyId(auth)));
    }
}
