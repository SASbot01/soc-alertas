package com.blackwolf.backend.controller;

import com.blackwolf.backend.dto.PentestDTOs.*;
import com.blackwolf.backend.model.PenetrationTest;
import com.blackwolf.backend.model.PentestFinding;
import com.blackwolf.backend.service.PentestService;
import com.blackwolf.backend.util.AuthUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/v1/pentests")
public class PentestController {

    @Autowired
    private PentestService pentestService;

    @Autowired
    private AuthUtils authUtils;

    @GetMapping
    public ResponseEntity<List<PenetrationTest>> list(Authentication auth) {
        return ResponseEntity.ok(pentestService.listByCompany(authUtils.getCompanyId(auth)));
    }

    @GetMapping("/{id}")
    public ResponseEntity<PentestDetailResponse> getDetail(Authentication auth, @PathVariable String id) {
        return ResponseEntity.ok(pentestService.getDetail(id, authUtils.getCompanyId(auth)));
    }

    @PostMapping
    public ResponseEntity<PenetrationTest> create(Authentication auth, @RequestBody CreatePentestRequest request) {
        String companyId = authUtils.getCompanyId(auth);
        String performedBy = authUtils.getUser(auth).getEmail();
        return ResponseEntity.ok(pentestService.create(companyId, request, performedBy));
    }

    @PatchMapping("/{id}/status")
    public ResponseEntity<PenetrationTest> updateStatus(Authentication auth, @PathVariable String id,
                                                         @RequestBody UpdatePentestStatusRequest request) {
        String companyId = authUtils.getCompanyId(auth);
        String performedBy = authUtils.getUser(auth).getEmail();
        return ResponseEntity.ok(pentestService.updateStatus(id, companyId, request, performedBy));
    }

    @PostMapping("/{id}/findings")
    public ResponseEntity<PentestFinding> addFinding(Authentication auth, @PathVariable String id,
                                                      @RequestBody CreatePentestFindingRequest request) {
        String companyId = authUtils.getCompanyId(auth);
        String performedBy = authUtils.getUser(auth).getEmail();
        return ResponseEntity.ok(pentestService.addFinding(id, companyId, request, performedBy));
    }
}
